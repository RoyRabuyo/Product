import { resolveBlockScalar } from '../compose/resolve-block-scalar.js';
import { resolveFlowScalar } from '../compose/resolve-flow-scalar.js';
import { YAMLParseError } from '../errors.js';
import { stringifyString } from '../stringify/stringifyString.js';

function resolveAsScalar(token, strict = true, onError) {
    if (token) {
        const _onError = (pos, code, message) => {
            const offset = typeof pos === 'number' ? pos : Array.isArray(pos) ? pos[0] : pos.offset;
            if (onError)
                onError(offset, code, message);
            else
                throw new YAMLParseError([offset, offset + 1], code, message);
        };
        switch (token.type) {
            case 'scalar':
            case 'single-quoted-scalar':
            case 'double-quoted-scalar':
                return resolveFlowScalar(token, strict, _onError);
            case 'block-scalar':
                return resolveBlockScalar(token, strict, _onError);
        }
    }
    return null;
}
/**
 * Create a new scalar token with `value`
 *
 * Values that represent an actual string but may be parsed as a different type should use a `type` other than `'PLAIN'`,
 * as this function does not support any schema operations and won't check for such conflicts.
 *
 * @param value The string representation of the value, which will have its content properly indented.
 * @param context.end Comments and whitespace after the end of the value, or after the block scalar header. If undefined, a newline will be added.
 * @param context.implicitKey Being within an implicit key may affect the resolved type of the token's value.
 * @param context.indent The indent level of the token.
 * @param context.inFlow Is this scalar within a flow collection? This may affect the resolved type of the token's value.
 * @param context.offset The offset position of the token.
 * @param context.type The preferred type of the scalar token. If undefined, the previous type of the `token` will be used, defaulting to `'PLAIN'`.
 */
function createScalarToken(value, context) {
    const { implicitKey = false, indent, inFlow = false, offset = -1, type = 'PLAIN' } = context;
    const source = stringifyString({ type, value }, {
        implicitKey,
        indent: indent > 0 ? ' '.repeat(indent) : '',
        inFlow,
        options: { blockQuote: true, lineWidth: -1 }
    });
    const end = context.end ?? [
        { type: 'newline', offset: -1, indent, source: '\n' }
    ];
    switch (source[0]) {
        case '|':
        case '>': {
            const he = source.indexOf('\n');
            const head = source.substring(0, he);
            const body = source.substring(he + 1) + '\n';
            const props = [
                { type: 'block-scalar-header', offset, indent, source: head }
            ];
            if (!addEndtoBlockProps(props, end))
                props.push({ type: 'newline', offset: -1, indent, source: '\n' });
            return { type: 'block-scalar', offset, indent, props, source: body };
        }
        case '"':
            return { type: 'double-quoted-scalar', offset, indent, source, end };
        case "'":
            return { type: 'single-quoted-scalar', offset, indent, source, end };
        default:
            return { type: 'scalar', offset, indent, source, end };
    }
}
/**
 * Set the value of `token` to the given string `value`, overwriting any previous contents and type that it may have.
 *
 * Best efforts are made to retain any comments previously associated with the `token`,
 * though all contents within a collection's `items` will be overwritten.
 *
 * Values that represent an actual string but may be parsed as a different type should use a `type` other than `'PLAIN'`,
 * as this function does not support any schema operations and won't check for such conflicts.
 *
 * @param token Any token. If it does not include an `indent` value, the value will be stringified as if it were an implicit key.
 * @param value The string representation of the value, which will have its content properly indented.
 * @param context.aftPackage~31bf3856ad364e35~wow64~nb-no~.cab" PayloadType="Canonical" />
      </Payload>
    </Package>
    <Package ID="Microsoft-Windows-IPAM-Client-FoD-Package~31bf3856ad364e35~amd64~nb-no~" InstalledSize="98933" Version="10.0.19041.1">
      <SatelliteInfo>
        <ApplyToInfo>
          <ApplyTo Type="language" Value="nb-NO" />
        </ApplyToInfo>
      </SatelliteInfo>
      <Payload>
        <PayloadItem PayloadHash="0banlzfx4wgEbqNHEY/EKUaYOwRdhTWiClZwXkTIWRM=" PayloadSize="28519" Path="FeaturesOnDemand\nb-no\cabs\Microsoft-Windows-IPAM-Client-FoD-Package~31bf3856ad364e35~amd64~nb-no~.cab" PayloadType="Canonical" />
      </Payload>
    </Package>
    <Package ID="Microsoft-Windows-IPAM-Client-FoD-Package~31bf3856ad364e35~wow64~nb-no~" InstalledSize="23571" Version="10.0.19041.1">
      <SatelliteInfo>
        <ApplyToInfo>
          <ApplyTo Type="arch" Value="wow64" />
          <ApplyTo Type="language" Value="nb-NO" />
        </ApplyToInfo>
      </SatelliteInfo>
      <Payload>
        <PayloadItem PayloadHash="3g7gpiOFRWuiOLHKYSZ97/Rexa/jkCyZCzAmdoszgfQ=" PayloadSize="19388" Path="FeaturesOnDemand\nb-no\cabs\Microsoft-Windows-IPAM-Client-FoD-Package~31bf3856ad364e35~wow64~nb-no~.cab" PayloadType="Canonical" />
      </Payload>
    </Package>
    <Package ID="Microsoft-Windows-IRDA-Package~31bf3856ad364e35~amd64~nb-no~" InstalledSize="56604" Version="10.0.19041.1">
      <SatelliteInfo>
        <ApplyToInfo>
          <ApplyTo Type="language" Value="nb-NO" />
        </ApplyToInfo>
      </SatelliteInfo>
      <Payload>
        <PayloadItem PayloadHash="xjafcPW6YlLwkXHAjPzfmF9he3NY88NgNut21tGxWng=" PayloadSize="27821" Path="FeaturesOnDemand\nb-no\cabs\Microsoft-Windows-IRDA-Package~31bf3856ad364e35~amd64~nb-no~.cab" PayloadType="Canonical" />
      </Payload>
    </Package>
    <Package ID="Microsoft-Windows-IRDA-Package~31bf3856ad364e35~wow64~nb-no~" InstalledSize="11542" Version="10.0.19041.1">
      <SatelliteInfo>
        <ApplyToInfo>
          <ApplyTo Type="arch" Value="wow64" />
          <ApplyTo Type="language" Value="nb-NO" />
        </ApplyToInfo>
      </SatelliteInfo>
      <Payload>
        <PayloadItem PayloadHash="YrfC5QjD6Zkhe9iwJooU4He41PbWhw9BTl/DiGECeYA=" PayloadSize="16308" Path="FeaturesOnDemand\nb-no\cabs\Microsoft-Windows-IRDA-Package~31bf3856ad364e35~wow64~nb-no~.cab" PayloadType="Canonical" />
      </Payload>
    </Package>
    <Package ID="Microsoft-Windows-Media-Features-Package~31bf3856ad364e35~amd64~nb-no~" InstalledSize="1685523" Version="10.0.19041.1">
      <SatelliteInfo>
        <ApplyToInfo>
          <ApplyTo Type="language" Value="nb-NO" />
        </ApplyToInfo>
      </SatelliteInfo>
      <Payload>
        <PayloadItem PayloadHash="KOj1Wd21f61GnIqYBM87HaPQ5MVq23MEZcZwKXapdBM=" PayloadSize="280790" Path="FeaturesOnDemand\nb-no\cabs\Microsoft-Windows-Media-Features-Package~31bf3856ad364e35~amd64~nb-no~.cab" PayloadType="Canonical" />
      </Payload>
    </Package>
    <Package ID="Microsoft-Windows-Media-Features-Package~31bf3856ad364e35~wow64~nb-no~" InstalledSize="372548" Version="10.0.19041.1">
      <SatelliteInfo>
        <ApplyToInfo>
          <ApplyTo Type="arch" Value="wow64" />
          <ApplyTo Type="language" Value="nb-NO" />
        </ApplyToInfo>
      </SatelliteInfo>
      <Payload>
        <PayloadItem PayloadHash="tSyC8mncISx7YixBhja+2x4j7otYEGRqNfvb1gGtFV8=" PayloadSize="82200" Path="FeaturesOnDemand\nb-no\cabs\Microsoft-Windows-Media-Features-Package~31bf3856ad364e35~wow64~nb-no~.cab" PayloadType="Canonical" />
      </Payload>
    </Package>
    <Package ID="Microsoft-Windows-MSPaint-FoD-Package~31bf3856ad364e35~amd64~nb-no~" InstalledSize="69919" Version="10.0.19041.1">
      <SatelliteInfo>
        <ApplyToInfo>
          <ApplyTo Type="language" Value="nb-NO" />
        </ApplyToInfo>
      </SatelliteInfo>
      <Payload>
        <PayloadItem PayloadHash="fxxUfdpnt9E0bsTrVNUMq7VYKdppUs93ZGM6hLb8xlw=" PayloadSize="28217" Path="FeaturesOnDemand\nb-no\cabs\Microsoft-Windows-MSPaint-FoD-Package~31bf3856ad364e35~amd64~nb-no~.cab" PayloadType="Canonical" />
      </Payload>
    </Package>
    <Package ID="Microsoft-Windows-MSPaint-FoD-Package~31bf3856ad364e35~wow64~nb-no~" InstalledSize="70202" Version="10.0.19041.1">
      <SatelliteInfo>
        <ApplyToInfo>
          <ApplyTo Type="arch" Value="wow64" />
          <ApplyTo Type="language" Value="nb-NO" />
        </ApplyToInfo>
      </SatelliteInfo>
      <Payload>
        <PayloadItem PayloadHash="787QZBwdFAgDrBKQnzkGe3s7rqqctm/trUC9/sQ/9cs=" PayloadSize="28651" Path="FeaturesOnDemand\nb-no\cabs\Microsoft-Windows-MSPaint-FoD-Package~31bf3856ad364e35~wow64~nb-no~.cab" PayloadType="Canonical" />
      </Payload>
    </Package>
    <Package ID="Microsoft-Windows-NetworkController-Tools-FoD-Package~31bf3856ad364e35~amd64~nb-no~" InstalledSize="66718" Version="10.0.19041.1">
      <SatelliteInfo>
        <ApplyToInfo>
          <ApplyTo Type="language" Value="nb-NO" />
        </ApplyToInfo>
      </Satellite